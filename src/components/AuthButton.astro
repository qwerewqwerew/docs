---
// ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸
---

<div id="auth-container">
  <div id="auth-loading">ë¡œë”©ì¤‘...</div>
  <div id="auth-logged-out" style="display: none;">
    <button id="login-github" class="btn-login">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
      </svg>
      GitHub ë¡œê·¸ì¸
    </button>
    <button id="login-google" class="btn-login">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.792 4.792 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.702 3.702 0 0 0 1.599-2.431H8v-3.08h7.545z"/>
      </svg>
      Google ë¡œê·¸ì¸
    </button>
  </div>
  <div id="auth-logged-in" style="display: none;">
    <span id="user-info"></span>
    <button id="logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<style>
  #auth-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  #auth-logged-out {
    display: flex;
    gap: 0.5rem;
  }

  #auth-logged-in {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  #user-info {
    font-size: 0.9rem;
    color: var(--sl-color-gray-2);
  }

  .btn-login,
  .btn-logout {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 6px;
    background: var(--sl-color-bg);
    color: var(--sl-color-text);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-login:hover {
    background: var(--sl-color-gray-6);
    border-color: var(--sl-color-gray-4);
  }

  .btn-logout {
    background: var(--sl-color-gray-5);
  }

  .btn-logout:hover {
    background: var(--sl-color-gray-4);
  }

  #auth-loading {
    font-size: 0.9rem;
    color: var(--sl-color-gray-3);
  }
</style>

<script>
  import { supabase } from '@/lib/supabase';

  console.log('ğŸš€ AuthButton ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨');

  const authContainer = document.getElementById('auth-container');
  const authLoading = document.getElementById('auth-loading');
  const authLoggedOut = document.getElementById('auth-logged-out');
  const authLoggedIn = document.getElementById('auth-logged-in');
  const userInfo = document.getElementById('user-info');
  const loginGithub = document.getElementById('login-github');
  const loginGoogle = document.getElementById('login-google');
  const logoutBtn = document.getElementById('logout');

  console.log('ğŸ” ë²„íŠ¼ ìš”ì†Œ:', { loginGithub, loginGoogle });

  // í˜„ì¬ ì‚¬ìš©ì í™•ì¸
  async function checkUser() {
    const { data: { user } } = await supabase.auth.getUser();

    if (authLoading) authLoading.style.display = 'none';

    const loginRequired = document.getElementById('login-required');
    const boardContent = document.getElementById('board-content');
    const btnAdd = document.getElementById('btn-add');

    if (user) {
      // ë¡œê·¸ì¸ ìƒíƒœ
      if (authLoggedIn) authLoggedIn.style.display = 'flex';
      if (authLoggedOut) authLoggedOut.style.display = 'none';
      if (userInfo) userInfo.textContent = `ğŸ‘¤ ${user.email || user.user_metadata.name}`;

      // ê²Œì‹œíŒ ì½˜í…ì¸  í‘œì‹œ
      if (loginRequired) loginRequired.style.display = 'none';
      if (boardContent) boardContent.style.display = 'block';
      if (btnAdd) btnAdd.style.display = 'block';

      // ë²„íŠ¼ ê¶Œí•œ ì²´í¬ (PostListì˜ í•¨ìˆ˜ í˜¸ì¶œ)
      if (typeof window.checkButtonPermissions === 'function') {
        window.checkButtonPermissions();
      }
    } else {
      // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
      if (authLoggedIn) authLoggedIn.style.display = 'none';
      if (authLoggedOut) authLoggedOut.style.display = 'flex';

      // ë¡œê·¸ì¸ ìš”êµ¬ ë©”ì‹œì§€ í‘œì‹œ
      if (loginRequired) loginRequired.style.display = 'block';
      if (boardContent) boardContent.style.display = 'none';
      if (btnAdd) btnAdd.style.display = 'none';
    }
  }

  // GitHub ë¡œê·¸ì¸
  loginGithub?.addEventListener('click', async () => {
    console.log('ğŸ”‘ GitHub ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨!');
    console.log('ğŸ“ í˜„ì¬ ìœ„ì¹˜:', window.location.href);
    console.log('ğŸ“ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL:', window.location.origin + '/board/');

    try {
      console.log('ğŸ”„ signInWithOAuth í˜¸ì¶œ ì¤‘...');
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'github',
        options: {
          redirectTo: window.location.origin + '/board/'
        }
      });

      console.log('ğŸ“¦ ì‘ë‹µ ë°ì´í„°:', data);
      console.log('â— ì‘ë‹µ ì—ëŸ¬:', error);

      if (error) {
        console.error('âŒ GitHub ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        alert('GitHub ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
      } else {
        console.log('âœ… GitHub ë¡œê·¸ì¸ ì„±ê³µ');
      }
    } catch (err) {
      console.error('âŒ ì˜ˆì™¸ ë°œìƒ:', err);
      alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  // Google ë¡œê·¸ì¸
  loginGoogle?.addEventListener('click', async () => {
    console.log('ğŸ”‘ Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨!');
    console.log('ğŸ“ í˜„ì¬ ìœ„ì¹˜:', window.location.href);

    try {
      console.log('ğŸ”„ signInWithOAuth í˜¸ì¶œ ì¤‘...');
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + '/board/'
        }
      });

      console.log('ğŸ“¦ ì‘ë‹µ ë°ì´í„°:', data);
      console.log('â— ì‘ë‹µ ì—ëŸ¬:', error);

      if (error) {
        console.error('âŒ Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        alert('Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
      } else {
        console.log('âœ… Google ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤‘...');
      }
    } catch (err) {
      console.error('âŒ ì˜ˆì™¸ ë°œìƒ:', err);
      alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  // ë¡œê·¸ì•„ì›ƒ
  logoutBtn?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.reload();
  });

  // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN') {
      window.location.reload();
    }
  });

  checkUser();
</script>
