---
import { supabase } from '@/lib/supabase';
import AuthButton from '@/components/AuthButton.astro';

const { data: posts, error } = await supabase
  .from('posts')
  .select('*')
  .order('created_at', { ascending: false });

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
};
---

<div class="board">
  <div class="header">
    <div class="header-left">
      <h1>ğŸ“ ê²Œì‹œíŒ</h1>
      <button class="btn-add" id="btn-add" style="display: none;">+ ê¸€ì“°ê¸°</button>
    </div>
    <AuthButton />
  </div>

  <div id="login-required" class="login-required" style="display: none;">
    <p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
    <p>GitHub ë˜ëŠ” Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
  </div>

  <div id="board-content" style="display: none;">
    <div class="form-container" id="form-container" style="display: none;">
      <form id="post-form">
        <input type="hidden" id="post-id" />
        <input type="text" id="author" placeholder="ì‘ì„±ì" required />
        <input type="text" id="title" placeholder="ì œëª©" required />
        <textarea id="content" placeholder="ë‚´ìš©" rows="5" required></textarea>
        <div class="form-btns">
          <button type="submit" class="btn-save">ì €ì¥</button>
          <button type="button" class="btn-cancel" id="btn-cancel">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>

    {error && <div class="error">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>}

    {posts && posts.length === 0 && (
      <div class="empty">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>
    )}

    {posts && posts.length > 0 && (
      <table class="list">
        <thead>
          <tr>
            <th>ë²ˆí˜¸</th>
            <th>ì œëª©</th>
            <th>ì‘ì„±ì</th>
            <th>ì‘ì„±ì¼</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="post-list">
          {posts.map((post, index) => (
            <tr data-id={post.id} data-user-id={post.user_id}>
              <td>{posts.length - index}</td>
              <td class="title">{post.title}</td>
              <td>{post.author}</td>
              <td>{formatDate(post.created_at)}</td>
              <td class="actions">
                <button class="btn-edit" data-id={post.id} style="display: none;">ìˆ˜ì •</button>
                <button class="btn-delete" data-id={post.id} style="display: none;">ì‚­ì œ</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    )}
  </div>
</div>


<style>
  .board {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .header h1 {
    margin: 0;
    font-size: 1.8rem;
  }

  .btn-add {
    padding: 0.6rem 1.2rem;
    background: var(--sl-color-accent);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .btn-add:hover {
    background: var(--sl-color-accent-high);
  }

  .form-container {
    background: var(--sl-color-bg-sidebar);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  #post-form {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  #post-form input,
  #post-form textarea {
    padding: 0.6rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 4px;
    background: var(--sl-color-bg);
    color: var(--sl-color-text);
    font-family: inherit;
    font-size: 0.95rem;
  }

  #post-form textarea {
    resize: vertical;
  }

  .form-btns {
    display: flex;
    gap: 0.5rem;
  }

  .btn-save,
  .btn-cancel {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .btn-save {
    background: var(--sl-color-accent);
    color: white;
  }

  .btn-cancel {
    background: var(--sl-color-gray-5);
    color: var(--sl-color-text);
  }

  .login-required {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--sl-color-bg-sidebar);
    border-radius: 8px;
    margin-top: 2rem;
  }

  .login-required p {
    font-size: 1.1rem;
    color: var(--sl-color-gray-3);
    margin: 0.5rem 0;
  }

  .login-required p:first-child {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--sl-color-text);
  }

  .error,
  .empty {
    padding: 2rem;
    text-align: center;
    color: var(--sl-color-gray-3);
    background: var(--sl-color-bg-sidebar);
    border-radius: 8px;
  }

  .list {
    width: 100%;
    border-collapse: collapse;
    background: var(--sl-color-bg-sidebar);
    border-radius: 8px;
    overflow: hidden;
  }

  .list th {
    background: var(--sl-color-gray-6);
    padding: 0.8rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .list td {
    padding: 0.8rem;
    border-top: 1px solid var(--sl-color-gray-5);
    font-size: 0.9rem;
  }

  .list tr:hover {
    background: var(--sl-color-gray-6);
  }

  .list .title {
    font-weight: 500;
  }

  .list th:nth-child(1),
  .list td:nth-child(1) {
    width: 60px;
    text-align: center;
  }

  .list th:nth-child(3),
  .list td:nth-child(3) {
    width: 100px;
  }

  .list th:nth-child(4),
  .list td:nth-child(4) {
    width: 150px;
  }

  .list th:nth-child(5),
  .list td:nth-child(5) {
    width: 130px;
    text-align: center;
  }

  .actions {
    display: flex;
    gap: 0.3rem;
    justify-content: center;
  }

  .btn-edit,
  .btn-delete {
    padding: 0.3rem 0.7rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .btn-edit {
    background: var(--sl-color-accent);
    color: white;
  }

  .btn-delete {
    background: #dc3545;
    color: white;
  }

  .btn-edit:hover {
    background: var(--sl-color-accent-high);
  }

  .btn-delete:hover {
    background: #c82333;
  }
</style>

<script>
  import { supabase } from '@/lib/supabase';

  const btnAdd = document.getElementById('btn-add');
  const btnCancel = document.getElementById('btn-cancel');
  const formContainer = document.getElementById('form-container');
  const postForm = document.getElementById('post-form') as HTMLFormElement;
  const postId = document.getElementById('post-id') as HTMLInputElement;
  const author = document.getElementById('author') as HTMLInputElement;
  const title = document.getElementById('title') as HTMLInputElement;
  const content = document.getElementById('content') as HTMLTextAreaElement;

  // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  async function getCurrentUser() {
    const { data: { user } } = await supabase.auth.getUser();
    return user;
  }

  // ì‚¬ìš©ì ì—­í•  í™•ì¸
  async function getUserRole() {
    const user = await getCurrentUser();
    if (!user) return null;

    const { data } = await supabase
      .from('user_profiles')
      .select('role')
      .eq('id', user.id)
      .single();

    return data?.role || 'author';
  }

  // ë²„íŠ¼ ê¶Œí•œ ì²´í¬ ë° í‘œì‹œ
  async function checkButtonPermissions() {
    const user = await getCurrentUser();
    if (!user) return;

    const role = await getUserRole();

    document.querySelectorAll('[data-user-id]').forEach(row => {
      const postUserId = row.getAttribute('data-user-id');
      const editBtn = row.querySelector('.btn-edit');
      const deleteBtn = row.querySelector('.btn-delete');

      // Adminì€ ëª¨ë“  ë²„íŠ¼ í‘œì‹œ, AuthorëŠ” ìì‹ ì˜ ê¸€ë§Œ í‘œì‹œ
      const canManage = role === 'admin' || postUserId === user.id;

      if (editBtn) (editBtn as HTMLElement).style.display = canManage ? 'inline-block' : 'none';
      if (deleteBtn) (deleteBtn as HTMLElement).style.display = canManage ? 'inline-block' : 'none';
    });
  }

  // ê¸€ì“°ê¸° ë²„íŠ¼
  btnAdd?.addEventListener('click', async () => {
    postForm?.reset();
    if (postId) postId.value = '';

    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ë¡œ ì‘ì„±ì ìë™ ì…ë ¥
    const user = await getCurrentUser();
    if (user && author) {
      author.value = user.email || user.user_metadata.name || 'ìµëª…';
      author.readOnly = true;
    }

    if (formContainer) formContainer.style.display = 'block';
  });

  // ì·¨ì†Œ ë²„íŠ¼
  btnCancel?.addEventListener('click', () => {
    if (formContainer) formContainer.style.display = 'none';
    postForm?.reset();
    if (author) author.readOnly = false;
  });

  // ì €ì¥ (ë“±ë¡/ìˆ˜ì •)
  postForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // ì¸ì¦ í™•ì¸
    const user = await getCurrentUser();
    if (!user) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }

    const id = postId?.value;
    const data = {
      author: author.value,
      title: title.value,
      content: content.value,
      user_id: user.id  // ì‚¬ìš©ì ID ì¶”ê°€
    };

    try {
      if (id) {
        // ìˆ˜ì •
        const { error } = await supabase
          .from('posts')
          .update(data)
          .eq('id', id);

        if (error) throw error;
        alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        // ë“±ë¡
        const { error } = await supabase
          .from('posts')
          .insert(data);

        if (error) throw error;
        alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      window.location.reload();
    } catch (error) {
      console.error(error);
      alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
    }
  });

  // ìˆ˜ì • ë²„íŠ¼
  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = (e.target as HTMLElement).dataset.id;

      try {
        const { data, error } = await supabase
          .from('posts')
          .select('*')
          .eq('id', id)
          .single();

        if (error) throw error;

        if (postId) postId.value = data.id;
        if (author) author.value = data.author;
        if (title) title.value = data.title;
        if (content) content.value = data.content;
        if (formContainer) formContainer.style.display = 'block';
      } catch (error) {
        console.error(error);
        alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      }
    });
  });

  // ì‚­ì œ ë²„íŠ¼
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const id = (e.target as HTMLElement).dataset.id;

      try {
        const { error } = await supabase
          .from('posts')
          .delete()
          .eq('id', id);

        if (error) throw error;

        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.reload();
      } catch (error) {
        console.error(error);
        alert('ì‚­ì œ ì‹¤íŒ¨');
      }
    });
  });

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
  window.checkButtonPermissions = checkButtonPermissions;

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ ì²´í¬
  checkButtonPermissions();
</script>


